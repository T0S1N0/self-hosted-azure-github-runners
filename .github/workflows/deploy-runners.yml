# Deploy self-hosted GitHub Actions runners on Azure
# Full automation: Terraform â†’ Ansible â†’ Configure runners
# See README "Automated deployment (GitHub Actions)" for setup

name: ğŸš€ Deploy Self-Hosted Runners

on:
  workflow_dispatch:
    inputs:
      runner_count:
        description: 'Number of runners to deploy'
        required: false
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'
          - '10'
  push:
    branches: [main]
    paths:
      - '.github/workflows/deploy-runners.yml'
      - 'terraform/**'
      - 'ansible/**'
      - 'scripts/**'

permissions:
  contents: read
  id-token: write   # Azure OIDC authentication
  actions: write    # Job summaries

env:
  TF_VAR_runner_count: ${{ github.event.inputs.runner_count || '3' }}
  TF_VAR_admin_username: azureuser
  AZURE_RESOURCE_GROUP: github-runners-rg

jobs:
  deploy:
    name: ğŸ—ï¸ Deploy Infrastructure & Configure Runners
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform

    steps:
      # ==================== SETUP ====================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Generate SSH key pair for VMs
        id: ssh-key
        run: |
          echo "::group::Generating RSA-4096 key pair"
          ssh-keygen -t rsa -b 4096 -f runner_key -N "" -C "github-actions-${{ github.run_id }}"
          echo "::endgroup::"
          
          echo "public_key<<EOF" >> $GITHUB_OUTPUT
          cat runner_key.pub >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Store private key for Ansible
          cp runner_key "$GITHUB_WORKSPACE/ansible/runner_key.pem"
          chmod 600 "$GITHUB_WORKSPACE/ansible/runner_key.pem"
          
          echo "âœ… SSH key pair generated"

      # ==================== AZURE & TERRAFORM ====================
      - name: ğŸ” Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          terraform_wrapper: false

      - name: ğŸ”§ Terraform Init
        run: |
          echo "::group::Initializing Terraform with Azure backend"
          terraform init
          echo "::endgroup::"
          echo "âœ… Terraform initialized (backend: azurerm)"
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ğŸ“‹ Terraform Plan
        id: plan
        run: |
          echo "::group::Planning infrastructure changes"
          terraform plan -out=tfplan -input=false
          echo "::endgroup::"
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_ssh_public_key: ${{ steps.ssh-key.outputs.public_key }}

      - name: ğŸš€ Terraform Apply
        id: terraform-apply
        run: |
          echo "::group::Applying Terraform configuration"
          terraform apply -auto-approve tfplan
          echo "::endgroup::"
          
          echo "::group::Resource outputs"
          terraform output
          echo "::endgroup::"
          
          IPS=$(terraform output -json runner_public_ips_list)
          echo "runner_ips=$IPS" >> $GITHUB_OUTPUT
          
          echo "âœ… Infrastructure deployed successfully"
          echo "ğŸ“ Runner IPs: $(echo $IPS | jq -r 'join(", ")')"
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_ssh_public_key: ${{ steps.ssh-key.outputs.public_key }}

      # ==================== GITHUB RUNNER TOKEN ====================
      - name: ğŸ« Get runner registration token
        id: token
        run: |
          echo "::group::Requesting runner registration token from GitHub API"
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token")
          echo "::endgroup::"
          
          TOKEN=$(echo "$RESPONSE" | jq -r '.token')
          if [[ -z "$TOKEN" || "$TOKEN" == "null" ]]; then
            echo "âŒ Error: Failed to get registration token"
            echo "Response: $RESPONSE"
            exit 1
          fi
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… Registration token obtained"

      # ==================== ANSIBLE CONFIGURATION ====================
      - name: ğŸ“ Generate Ansible inventory
        working-directory: ${{ github.workspace }}
        run: |
          echo "::group::Creating Ansible inventory from Terraform outputs"
          IPS='${{ steps.terraform-apply.outputs.runner_ips }}'
          
          {
            echo "# Ansible inventory - Auto-generated by GitHub Actions"
            echo "# Workflow: ${{ github.workflow }} #${{ github.run_number }}"
            echo "# Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            echo "[runners]"
            i=1
            for ip in $(echo "$IPS" | jq -r '.[]'); do
              echo "runner-$i ansible_host=$ip runner_name=runner-$i"
              ((i++))
            done
            echo ""
            echo "[runners:vars]"
            echo "ansible_user=${{ env.TF_VAR_admin_username }}"
          } > ansible/hosts
          echo "::endgroup::"
          
          echo "ğŸ“‹ Ansible inventory:"
          cat ansible/hosts
          echo ""
          echo "âœ… Inventory generated with ${{ env.TF_VAR_runner_count }} host(s)"

      - name: ğŸ“¦ Install Ansible
        working-directory: ${{ github.workspace }}
        run: |
          echo "::group::Installing Ansible"
          sudo apt-get update -qq
          sudo apt-get install -y ansible
          echo "::endgroup::"
          echo "âœ… Ansible $(ansible --version | head -n1) installed"

      - name: ğŸ¤– Configure runners with Ansible
        working-directory: ${{ github.workspace }}/ansible
        run: |
          echo "::group::Running Ansible playbook"
          echo "ğŸ¯ Target: ${{ env.TF_VAR_runner_count }} runners"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo ""
          
          ansible-playbook configure_runners.yml \
            -e "github_repo_url=https://github.com/${{ github.repository }}" \
            -e "github_runner_registration_token=${{ steps.token.outputs.token }}" \
            -e "ansible_ssh_private_key_file=${{ github.workspace }}/ansible/runner_key.pem"
          echo "::endgroup::"
          
          echo ""
          echo "âœ… All runners configured and started successfully!"
        env:
          ANSIBLE_HOST_KEY_CHECKING: false

      # ==================== SUMMARY & CLEANUP ====================
      - name: ğŸ“Š Generate deployment summary
        if: success()
        run: |
          IPS='${{ steps.terraform-apply.outputs.runner_ips }}'
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸ‰ Deployment Successful!
          
          ### ğŸ–¥ï¸ Infrastructure
          - **Resource Group:** `${{ env.AZURE_RESOURCE_GROUP }}`
          - **Region:** East US
          - **Runners Deployed:** ${{ env.TF_VAR_runner_count }}
          
          ### ğŸ“ Runner IP Addresses
          EOF
          
          i=1
          for ip in $(echo "$IPS" | jq -r '.[]'); do
            echo "- **runner-$i:** \`$ip\`" >> $GITHUB_STEP_SUMMARY
            ((i++))
          done
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### âœ… Next Steps
          1. Verify runners: [Settings â†’ Actions â†’ Runners](https://github.com/${{ github.repository }}/settings/actions/runners)
          2. Runners should show as **Idle** and **Online**
          3. Use in workflows with: `runs-on: self-hosted`
          
          ### ğŸ”— Quick Links
          - [Azure Portal - Resource Group](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }})
          - [GitHub Runners](https://github.com/${{ github.repository }}/settings/actions/runners)
          EOF
          
          echo "âœ… Summary generated"

      - name: ğŸ§¹ Clean up SSH private key
        if: always()
        working-directory: ${{ github.workspace }}
        run: |
          rm -f ansible/runner_key.pem
          echo "âœ… Cleanup complete"
